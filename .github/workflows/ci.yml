# .github/workflows/ci.yml
name: Sharerapy CI/CD Pipeline

# FEATURE DEVELOPMENT (feature/*, feat/*):
# - Jest Unit Tests + React Testing Library (component validation)
# - ESLint Code Quality + TypeScript checks (code standards)
# - Robot Framework Backend (functional validation)
#
# PULL REQUEST TO DEVELOP:
# - All feature development tests PLUS
# - Robot Framework E2E Tests (full user workflow validation)
#
# DEVELOP BRANCH INTEGRATION:
# - All PR tests PLUS
# - Robot Framework Staging Tests (environment-specific validation)
# - Build verification for staging deployment
#
# PULL REQUEST TO MAIN (PRODUCTION):
# - All develop tests PLUS
# - Integration Validation (staging + regression Robot Framework tests)
#
# PRODUCTION DEPLOYMENT (main branch):
# - Complete test suite (Unit, ESLint, Backend, E2E, Integration)
# - Build verification + Vercel auto-deployment monitoring
# - Live production health checks (https://sharerapy.vercel.app/)

on:
  push:
    branches: [main, develop, feature/*, feat/*]
  pull_request:
    branches: [main, develop]

defaults:
  run:
    shell: bash

defaults:
  run:
    shell: bash

jobs:

  # ============================================
  # Unit Tests (feature, develop, main)
  # ============================================
  jest-unit-tests:
    name: Jest Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci
      - run: npm test
        env:
          NODE_ENV: test

      - run: npm test -- --coverage

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-coverage
          path: coverage/

  # ============================================
  # Lint + Type Check (feature, develop, main)
  # ============================================
  code-quality:
    name: ESLint + Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci
      - run: npm run lint
      - run: npx tsc --noEmit --skipLibCheck

  # ============================================
  # Frontend Integration Tests (develop + main only)
  # ============================================
  frontend-integration-tests:
    name: Jest Frontend Integration Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' ||
        github.ref == 'refs/heads/main' ||
        github.base_ref == 'develop' ||
        github.base_ref == 'main'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci
      - run: npm run test:frontend-integration
        env:
          NODE_ENV: test
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-integration-test-results
          path: coverage/

  # ============================================
  # Backend Robot + Jest Tests (develop + main only)
  # ============================================
  backend-tests:
    name: Robot/Jest Backend Integration Tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' ||
        github.ref == 'refs/heads/main' ||
        github.base_ref == 'develop' ||
        github.base_ref == 'main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - run: |
          npm ci
          pip install robotframework robotframework-requests robotframework-databaselibrary
          if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi

      - run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}

      - name: Start server
        run: |
          npm start &
          echo "SERVER_PID=$!" >> $GITHUB_ENV
          sleep 10

      - name: Run Robot Backend Tests
        run: |
          mkdir -p tests/robot/output
          robot --outputdir tests/robot/output --exclude E2E tests/robot/crud

      - name: Run AI Integration Tests
        run: npm run test:ai-integration
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          NODE_ENV: test

      - name: Stop Server
        if: always()
        run: kill $SERVER_PID 2>/dev/null || true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: robot-jest-backend-results
          path: tests/robot/output/

  # ============================================
  # Robot E2E Tests (PR to develop, push to develop)
  # ============================================
  e2e-tests:
    name: Robot E2E Tests
    runs-on: ubuntu-latest
    needs: [jest-unit-tests, frontend-integration-tests, backend-tests]
    if: |
      (github.event_name == 'pull_request' && github.base_ref == 'develop') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/develop')
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - run: |
          npm ci
          pip install -r requirements-test.txt

      - uses: browser-actions/setup-chrome@v1

      - run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}

      - name: Run E2E Tests
        run: |
          mkdir -p tests/robot/E2E/output
          robot --outputdir tests/robot/E2E/output tests/robot/E2E/
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY }}

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-results
          path: tests/robot/E2E/output/

  # ============================================
  # PR to Main – Integration + Regression
  # ============================================
  pr-main-integration-validation:
    name: Production Integration Validation
    runs-on: ubuntu-latest
    needs: [jest-unit-tests, code-quality, frontend-integration-tests, backend-tests, e2e-tests]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: |
          npm ci
          pip install robotframework robotframework-requests
          if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi

      - name: Run Staging + Regression Tests
        run: |
          mkdir -p pr-integration-results
          robot --include staging --include regression \
                --outputdir pr-integration-results tests/robot/crud/

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-main-integration-results
          path: pr-integration-results/

  # ============================================
  # Develop push – Full Regression (Staging)
  # ============================================
  develop-integration-validation:
    name: Full Regression (Develop)
    runs-on: ubuntu-latest
    needs: [jest-unit-tests, code-quality, frontend-integration-tests, backend-tests, e2e-tests]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: |
          npm ci
          pip install robotframework robotframework-requests
          if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi

      - name: Staging Health Check
        run: |
          for i in {1..10}; do
            if curl -fs https://sharerapy-staging.vercel.app/ >/dev/null; then
              echo "Staging is healthy."
              break
            fi
            echo "Retrying staging health check... ($i/10)"
            sleep 5
          done

      - name: Run Full Regression (Staging)
        run: |
          mkdir -p develop-regression-results
          robot --include regression --include staging \
                --outputdir develop-regression-results tests/robot/

  # ============================================
  # Main push – Live Production Verification
  # ============================================
  main-production-verification:
    name: Production Verification
    runs-on: ubuntu-latest
    needs: [jest-unit-tests, code-quality, backend-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - run: echo "Checking production health..."

      - name: Production Health Check
        run: |
          for i in {1..10}; do
            if curl -fs https://sharerapy.vercel.app/ >/dev/null; then
              echo "Production is healthy."
              exit 0
            fi
            echo "Retrying... ($i/10)"
            sleep 5
          done
          echo "Production health check FAILED"
          exit 1
